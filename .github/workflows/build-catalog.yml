name: Build and Publish Catalog Image (OLMv1)

on:
  workflow_dispatch:

permissions:
  packages: write
  contents: read

jobs:
  build-catalog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          # Install opm (Operator Package Manager) for FBC validation
          OPM_VERSION=v1.35.0
          curl -LO https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm
          sudo mv linux-amd64-opm /usr/local/bin/opm
          sudo chmod +x /usr/local/bin/opm
          opm version

      - name: Extract version from Makefile
        id: version
        run: |
          VERSION=$(grep "^CATALOG_TAG" Makefile | cut -d'=' -f2 | tr -d ' ')
          if [ -z "$VERSION" ]; then
            echo "‚ùå ERROR: Failed to extract VERSION from Makefile"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted VERSION: $VERSION"

      - name: Validate File-Based Catalog structure
        run: |
          echo "üîç Validating File-Based Catalog (FBC) structure..."
          make catalog-validate
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: FBC validation failed with 'make catalog-validate'"
            echo "Please ensure the catalog structure in catalogs/ is valid"
            exit 1
          fi
          echo "‚úÖ FBC structure validated successfully"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push catalog image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Containerfile.catalog
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/catalog:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository }}/catalog:latest

      - name: Display published image URLs
        run: |
          echo "‚úÖ Catalog image published successfully!"
          echo ""
          echo "üìç Published to:"
          echo "   ghcr.io/${{ github.repository }}/catalog:${{ steps.version.outputs.VERSION }}"
          echo "   ghcr.io/${{ github.repository }}/catalog:latest"
          echo ""
          echo "üîó View package: https://github.com/${{ github.repository }}/pkgs/container/catalog"
          echo ""
          echo "‚ú® This is an OLMv1 File-Based Catalog for modern OpenShift 4.19+ deployments."