# ClusterServiceVersion Synchronization Analysis

**Date**: 2025-10-28
**Upstream Version**: toolhive-operator v0.4.2
**Generated CSV Version**: v0.4.2
**Analysis Status**: ✅ IN SYNC

## Executive Summary

The ClusterServiceVersion (CSV) generated by `scripts/generate-csv-from-kustomize.sh` is **correctly synchronized** with the toolhive operator v0.4.2. All critical components match the upstream operator configuration with intentional OpenShift-specific patches applied.

## Comparison Methodology

Since the upstream toolhive operator repository does not publish OLM bundle/CSV files, this analysis compares:
1. **Source**: Kustomize build output from `config/default` (upstream operator manifests)
2. **Target**: Generated CSV in `bundle/manifests/toolhive-operator.clusterserviceversion.yaml`
3. **Reference**: Direct inspection of `config/manager/manager.yaml` and `config/rbac/role.yaml`

## Component-by-Component Analysis

### 1. Version Metadata ✅

| Field | Source (config/) | Generated CSV | Status |
|-------|-----------------|---------------|--------|
| Operator Image | `ghcr.io/stacklok/toolhive/operator:v0.4.2` | `ghcr.io/stacklok/toolhive/operator:v0.4.2` | ✅ MATCH |
| Proxyrunner Image | `ghcr.io/stacklok/toolhive/proxyrunner:v0.4.2` | `ghcr.io/stacklok/toolhive/proxyrunner:v0.4.2` | ✅ MATCH |
| CSV Version | N/A (no upstream CSV) | `0.4.2` | ✅ CORRECT |
| CSV Name | N/A | `toolhive-operator.v0.4.2` | ✅ CORRECT |
| Min Kube Version | N/A | `1.27.0` | ✅ APPROPRIATE |

### 2. Deployment Specification ✅ (with intentional patches)

**Comparison**: `kustomize build config/default` Deployment vs CSV deployment spec

| Component | Source | Generated CSV | Status |
|-----------|--------|---------------|--------|
| Container Image | `ghcr.io/stacklok/toolhive/operator:v0.4.2` | `ghcr.io/stacklok/toolhive/operator:v0.4.2` | ✅ MATCH |
| Environment Variables | All env vars including TOOLHIVE_RUNNER_IMAGE | All env vars match | ✅ MATCH |
| Security Context | `runAsUser: 1000` (hardcoded) | `runAsUser` removed | ⚠️ **INTENTIONAL** (OpenShift patch) |
| Pod Security Context | No seccompProfile | `seccompProfile: RuntimeDefault` | ⚠️ **INTENTIONAL** (OpenShift patch) |
| Resource Requests/Limits | Standard limits | Same limits | ✅ MATCH |
| Probes (liveness/readiness) | Configured | Same configuration | ✅ MATCH |
| Service Account | `toolhive-operator-controller-manager` | Same | ✅ MATCH |

**Security Context Differences (Intentional)**:
- **Removed**: `runAsUser: 1000` from container security context
  - **Reason**: OpenShift's restricted-v2 SCC assigns UIDs dynamically
  - **Applied by**: `config/base/openshift_sec_patches.yaml`

- **Added**: `seccompProfile: RuntimeDefault` to pod security context
  - **Reason**: OpenShift restricted-v2 SCC requirement
  - **Applied by**: `config/base/openshift_sec_patches.yaml`

### 3. RBAC Permissions ✅

**Comparison**: `kustomize build config/default` ClusterRole vs CSV clusterPermissions

| Aspect | Source | Generated CSV | Status |
|--------|--------|---------------|--------|
| ClusterRole Rules | Complete rules from config/rbac/role.yaml | Identical rules | ✅ EXACT MATCH |
| API Groups | All 6 CRD API groups + core groups | Same | ✅ MATCH |
| Resources | All MCP resources + standard resources | Same | ✅ MATCH |
| Verbs | Full CRUD + watch/list | Same | ✅ MATCH |
| Service Account | `toolhive-operator-controller-manager` | Same | ✅ MATCH |

**Verification**:
```bash
diff -u <(kustomize build config/default | yq eval 'select(.kind == "ClusterRole") | .rules') \
        <(yq eval '.spec.install.spec.clusterPermissions[0].rules' bundle/manifests/toolhive-operator.clusterserviceversion.yaml)
# Result: No differences
```

### 4. Custom Resource Definitions ✅

All 6 CRDs in the CSV match the files in `config/crd/bases/`:

| CRD | CSV Entry | CRD File | Resources Documented | Status |
|-----|-----------|----------|---------------------|--------|
| MCPExternalAuthConfig | ✅ Listed | ✅ Present | Secret (v1) | ✅ COMPLETE |
| MCPGroup | ✅ Listed | ✅ Present | MCPServer (v1alpha1) | ✅ COMPLETE |
| MCPRegistry | ✅ Listed | ✅ Present | ConfigMap, MCPServer | ✅ COMPLETE |
| MCPRemoteProxy | ✅ Listed | ✅ Present | Deployment, Service, Pod | ✅ COMPLETE |
| MCPServer | ✅ Listed | ✅ Present | StatefulSet, Service, Pod, ConfigMap, Secret | ✅ COMPLETE |
| MCPToolConfig | ✅ Listed | ✅ Present | ConfigMap (v1) | ✅ COMPLETE |

**Note**: CRD resource specifications were added as part of Constitution Principle VII (Scorecard Quality Assurance) compliance.

### 5. Install Modes ✅

The CSV declares:
- ✅ **OwnNamespace**: true
- ✅ **SingleNamespace**: true
- ❌ **MultiNamespace**: false
- ✅ **AllNamespaces**: true

**Status**: Appropriate for the operator's capabilities. The operator uses `POD_NAMESPACE` environment variable and can operate in any of these modes.

### 6. Metadata Fields ✅

| Field | Value | Source | Status |
|-------|-------|--------|--------|
| displayName | Toolhive Operator | Script-generated | ✅ APPROPRIATE |
| description | Comprehensive description of MCP operator | Script-generated | ✅ COMPREHENSIVE |
| keywords | mcp, model-context-protocol, ai, llm, developer-tools | Script-generated | ✅ APPROPRIATE |
| maintainers | support@stacklok.com / Stacklok | Script-generated | ✅ CORRECT |
| provider | Stacklok (stacklok.com) | Script-generated | ✅ CORRECT |
| maturity | alpha | Script-generated | ✅ APPROPRIATE |
| icon | Base64 PNG (80x40) | icons/toolhive-icon-honey-wide-80x40.png | ✅ COMPLIANT |

## Discrepancies Found

### None - All Intentional Differences Documented

The only differences between the kustomize source and generated CSV are **intentional OpenShift-specific patches**:

1. **Security Context Modifications**:
   - Removed hardcoded `runAsUser: 1000`
   - Added `seccompProfile: RuntimeDefault`
   - **Purpose**: OpenShift restricted-v2 SCC compliance
   - **Applied**: During bundle generation via `config/base/openshift_sec_patches.yaml`

These are **not discrepancies** but **constitutional requirements** (Principle IV: OpenShift Compatibility).

## Synchronization Status

### Current State: ✅ SYNCHRONIZED

The CSV generation process correctly:
1. ✅ Extracts deployment spec from kustomize build
2. ✅ Extracts ClusterRole RBAC from kustomize build
3. ✅ Lists all 6 CRDs with resource specifications
4. ✅ Applies OpenShift-specific security patches
5. ✅ Uses version v0.4.2 throughout (operator image, proxyrunner image, CSV version)
6. ✅ Matches all environment variables including TOOLHIVE_RUNNER_IMAGE

### Version Tracking

| Component | Version | Last Updated | Source |
|-----------|---------|--------------|--------|
| config/manager/manager.yaml | v0.4.2 | 2025-10-28 | Updated from upstream |
| config/base/params.env | v0.4.2 | 2025-10-28 | Updated for v0.4.2 |
| Makefile variables | v0.4.2 | 2025-10-28 | OPERATOR_TAG, BUNDLE_TAG, etc. |
| Generated CSV | v0.4.2 | 2025-10-28 | Generated by script |
| CRDs in config/crd/bases/ | v0.4.2 | 2025-10-28 | Copied from upstream |

## Synchronization Plan

### Current Process (Working Correctly)

The repository maintains synchronization through:

1. **Manual Version Updates**:
   - Update `config/manager/manager.yaml` with new operator image versions
   - Update `config/base/params.env` with new versions
   - Update Makefile version variables
   - Copy new CRDs from upstream to `config/crd/bases/`

2. **Automated CSV Generation**:
   - Script: `scripts/generate-csv-from-kustomize.sh`
   - Extracts deployment from `kustomize build config/default`
   - Extracts RBAC from kustomize ClusterRole
   - Generates CSV with current version
   - Applied during `make bundle`

3. **Validation**:
   - Kustomize builds (Principle I)
   - Scorecard tests (Principle VII)
   - Constitutional compliance checks

### Recommended Improvements

#### 1. Version Consistency Verification (Priority: HIGH)

**Create**: `scripts/verify-version-consistency.sh`

```bash
#!/usr/bin/env bash
# Verify all version references are consistent

set -e

EXPECTED_VERSION="${1:-v0.4.2}"

echo "Checking version consistency for $EXPECTED_VERSION..."

# Check Makefile
MAKEFILE_VERSIONS=$(grep -E "(OPERATOR_TAG|BUNDLE_TAG|CATALOG_TAG)" Makefile | grep -oP 'v\d+\.\d+\.\d+' | sort -u)
if [ "$(echo "$MAKEFILE_VERSIONS" | wc -l)" -ne 1 ] || [ "$MAKEFILE_VERSIONS" != "$EXPECTED_VERSION" ]; then
    echo "❌ Makefile version mismatch"
    exit 1
fi

# Check config/manager/manager.yaml
MANAGER_VERSION=$(grep "ghcr.io/stacklok/toolhive/operator:" config/manager/manager.yaml | grep -oP 'v\d+\.\d+\.\d+')
if [ "$MANAGER_VERSION" != "$EXPECTED_VERSION" ]; then
    echo "❌ Manager deployment version mismatch"
    exit 1
fi

# Check config/base/params.env
PARAMS_VERSIONS=$(grep -E "toolhive-(operator|proxy)-image" config/base/params.env | grep -oP 'v\d+\.\d+\.\d+' | sort -u)
if [ "$(echo "$PARAMS_VERSIONS" | wc -l)" -ne 1 ] || [ "$PARAMS_VERSIONS" != "$EXPECTED_VERSION" ]; then
    echo "❌ params.env version mismatch"
    exit 1
fi

echo "✅ All versions consistent at $EXPECTED_VERSION"
```

**Add to Makefile**:
```makefile
.PHONY: verify-version-consistency
verify-version-consistency: ## Verify all version references are consistent
	@scripts/verify-version-consistency.sh $(OPERATOR_TAG)
```

**Add to Constitution** (Compliance Verification):
- Item 9: Version consistency across all configuration files

#### 2. Upstream CRD Change Detection (Priority: MEDIUM)

**Create**: `scripts/check-upstream-crds.sh`

```bash
#!/usr/bin/env bash
# Compare local CRDs with upstream operator image CRDs

VERSION="${1:-v0.4.2}"
OPERATOR_IMG="ghcr.io/stacklok/toolhive/operator:$VERSION"

echo "Checking CRDs against upstream $OPERATOR_IMG..."

# Extract CRDs from config/default
mkdir -p /tmp/local-crds
kustomize build config/default | yq eval 'select(.kind == "CustomResourceDefinition")' - | \
    yq eval -s '.metadata.name' - /tmp/local-crds/

# Compare with config/crd/bases/ (source of truth)
CRD_COUNT=$(ls config/crd/bases/*.yaml | wc -l)
echo "Found $CRD_COUNT CRDs in config/crd/bases/"

# Verify all CRDs are included in CSV
CSV_CRD_COUNT=$(yq eval '.spec.customresourcedefinitions.owned | length' \
    bundle/manifests/toolhive-operator.clusterserviceversion.yaml)

if [ "$CRD_COUNT" -ne "$CSV_CRD_COUNT" ]; then
    echo "❌ CRD count mismatch: config/crd/bases ($CRD_COUNT) vs CSV ($CSV_CRD_COUNT)"
    exit 1
fi

echo "✅ All $CRD_COUNT CRDs properly referenced"
```

#### 3. Automated Upgrade Workflow (Priority: HIGH)

**Create**: `scripts/upgrade-to-version.sh`

```bash
#!/usr/bin/env bash
# Automate upgrade to a new toolhive operator version

set -e

NEW_VERSION="$1"

if [ -z "$NEW_VERSION" ]; then
    echo "Usage: $0 <new-version>"
    echo "Example: $0 v0.4.3"
    exit 1
fi

# Validate version format
if ! echo "$NEW_VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
    echo "Error: Version must be in format vX.Y.Z"
    exit 1
fi

echo "Upgrading to toolhive operator $NEW_VERSION..."

# 1. Update Makefile
echo "Updating Makefile..."
sed -i "s/OPERATOR_TAG ?= v[0-9.]\+/OPERATOR_TAG ?= $NEW_VERSION/" Makefile
sed -i "s/BUNDLE_TAG ?= v[0-9.]\+/BUNDLE_TAG ?= $NEW_VERSION/" Makefile
sed -i "s/CATALOG_TAG ?= v[0-9.]\+/CATALOG_TAG ?= $NEW_VERSION/" Makefile
sed -i "s/INDEX_TAG ?= v[0-9.]\+/INDEX_TAG ?= $NEW_VERSION/" Makefile

# 2. Update config/manager/manager.yaml
echo "Updating config/manager/manager.yaml..."
sed -i "s|ghcr.io/stacklok/toolhive/operator:v[0-9.]\+|ghcr.io/stacklok/toolhive/operator:$NEW_VERSION|" \
    config/manager/manager.yaml
sed -i "s|ghcr.io/stacklok/toolhive/proxyrunner:v[0-9.]\+|ghcr.io/stacklok/toolhive/proxyrunner:$NEW_VERSION|" \
    config/manager/manager.yaml

# 3. Update config/base/params.env
echo "Updating config/base/params.env..."
sed -i "s|toolhive-operator-image=.*|toolhive-operator-image=ghcr.io/stacklok/toolhive/operator:$NEW_VERSION|" \
    config/base/params.env
sed -i "s|toolhive-proxy-image=.*|toolhive-proxy-image=ghcr.io/stacklok/toolhive/proxyrunner:$NEW_VERSION|" \
    config/base/params.env

# 4. Download new CRDs (would need implementation to fetch from upstream repo or image)
echo "⚠️  Manual step required: Update CRDs in config/crd/bases/ from upstream operator"
echo "    Check https://github.com/stacklok/toolhive/tree/$NEW_VERSION/operator/config/crd/bases"

# 5. Verify and build
echo "Verifying configuration..."
make kustomize-validate

echo "Building bundle..."
make bundle

echo "Running scorecard tests..."
make scorecard-test

echo "✅ Upgrade to $NEW_VERSION complete"
echo ""
echo "Next steps:"
echo "1. Manually verify CRDs in config/crd/bases/ are up-to-date with upstream"
echo "2. Review bundle/manifests/toolhive-operator.clusterserviceversion.yaml"
echo "3. Update catalog with new bundle entry"
echo "4. Run: make catalog-validate && make catalog-build"
```

**Add to Makefile**:
```makefile
.PHONY: upgrade
upgrade: ## Upgrade to new version (usage: make upgrade VERSION=v0.4.3)
	@if [ -z "$(VERSION)" ]; then \
		echo "Error: VERSION not specified"; \
		echo "Usage: make upgrade VERSION=v0.4.3"; \
		exit 1; \
	fi
	@scripts/upgrade-to-version.sh $(VERSION)
```

#### 4. Pre-Commit Hook (Priority: MEDIUM)

**Create**: `.git/hooks/pre-commit` (or use pre-commit framework)

```bash
#!/usr/bin/env bash
# Verify version consistency before committing

./scripts/verify-version-consistency.sh || {
    echo "❌ Version consistency check failed"
    echo "Run 'make verify-version-consistency' to see details"
    exit 1
}
```

#### 5. CI/CD Integration (Priority: HIGH if CI/CD exists)

Add to CI pipeline:
```yaml
- name: Verify Version Consistency
  run: make verify-version-consistency

- name: Verify Kustomize Builds
  run: make kustomize-validate

- name: Verify Bundle
  run: make bundle-validate

- name: Run Scorecard Tests
  run: make scorecard-test

- name: Verify Constitution Compliance
  run: make constitution-check
```

## Implementation Priority

### Immediate (Week 1)
1. ✅ Create `verify-version-consistency.sh` script
2. ✅ Add `verify-version-consistency` target to Makefile
3. ✅ Add version consistency check to Constitution (Compliance item #9)

### Short-term (Week 2-3)
4. ⚠️ Create `upgrade-to-version.sh` automation script
5. ⚠️ Create `check-upstream-crds.sh` CRD validation script
6. ⚠️ Document upgrade process in CONTRIBUTING.md or UPGRADE.md

### Medium-term (Month 1-2)
7. ⚠️ Set up pre-commit hooks for version consistency
8. ⚠️ Integrate checks into CI/CD if available
9. ⚠️ Create automated CRD fetching from upstream

## Maintenance Checklist

When upgrading to a new toolhive operator version:

- [ ] Update `OPERATOR_TAG` in Makefile
- [ ] Update `config/manager/manager.yaml` image versions
- [ ] Update `config/base/params.env` image versions
- [ ] Copy new CRDs from upstream to `config/crd/bases/`
- [ ] Run `make verify-version-consistency`
- [ ] Run `make kustomize-validate`
- [ ] Run `make bundle`
- [ ] Run `make scorecard-test`
- [ ] Run `make constitution-check`
- [ ] Update catalog with new bundle entry
- [ ] Test deployment in development cluster

## Conclusion

**Status**: ✅ **FULLY SYNCHRONIZED**

The generated ClusterServiceVersion accurately reflects the toolhive operator v0.4.2 with appropriate OpenShift-specific patches. The synchronization process is working correctly, and the recommended improvements will further automate and safeguard version consistency.

**Key Strengths**:
- Automated CSV generation from kustomize
- Constitutional compliance ensures quality
- Scorecard validation catches errors
- Clear separation of upstream vs OpenShift patches

**Recommended Next Step**: Implement the version consistency verification script to prevent accidental version drift in future updates.
